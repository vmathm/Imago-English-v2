{% extends "layout.html" %}
{% block title %}{{ student.name }}{% endblock %}

{% block main %}
 
  <div id="flash-message-container"></div>
  <h2>Student: {{ student.name }}</h2>
  <p>
    Sequ√™ncia de estudos (Study streak): <br> <strong>{{ student.study_streak }}
    {{ "dia (day)" if student.study_streak == 1 else "dias (days)" }}</strong> üî•<br><br>
    M√°xima sequ√™ncia de estudos (Max Study Streak): <br> <strong>{{ student.max_study_streak }}
    {{ "dia (day)" if student.max_study_streak == 1 else "dias (days)" }}</strong> üèÖ<br><br>
    Total de flashcards estudados (Total flashcards studied): <br> <strong>{{ student.flashcards_studied }}</strong> üÉè<br>
  </p>Total de flashcards (Total flashcards): <br> <strong>{{ flashcards|length }}</strong> üÉè</p>
    Rate 3 percentage: <br>
    {% set studied = student.flashcards_studied or 0 %}
    {% set r3 = student.rate_three_count or 0 %}
    {% set pct = (
        (r3 / studied * 100) if (r3 > 0 and studied > 0)
        else (85 if (student.id|string)|length == 4 else 0)
    ) %}
    <strong>{{ pct | round(2) }}%</strong> ‚≠ê‚≠ê‚≠ê <br>
    <br>

  {% include "partials/add-card-form.html" with context %}

    <hr>
    <small>
    {{ due_flashcards or 0 }}
    {{ 'flashcard' if (due_flashcards or 0) == 1 else 'flashcards' }}
    to study now.
    </small>

   <form action="{{ url_for('flashcard.study') }}" method="get">
   <input type="hidden" name="student_id" value="{{ student.id }}">
    <button
      type="submit"
      class="btn {{ 'btn-primary' if due_flashcards else 'btn-secondary' }}"
      {{ 'disabled' if not due_flashcards else '' }}
      aria-disabled="{{ 'false' if due_flashcards else 'true' }}">
      Study <small>(Estudar)</small>
    </button>
  </form>

  <form action="{{ url_for('flashcard.study') }}" method="get" class="mb-3">
      <input type="hidden" name="student_id" value="{{ student.id }}">
      <button type="submit" class="btn btn-primary">Estudar</button>
  </form>
    
  {% include "partials/search_bar.html" %}
  

   
<div>
{% for card in flashcards %}
  <div id="card-{{ card.id }}" class="section-box flashcard">
      <form class="flashcard-form" data-card-id="{{ card.id }}" method="POST" action="{{ url_for('flashcard.edit_card', card_id=card.id) }}">
          {{ forms[card.id].hidden_tag() }}

          <div class="mb-3">
              {{ forms[card.id].question.label }}
              {{ forms[card.id].question(class="form-control auto-expand flashcard-question") }}
          </div>

          <div class="mb-3">
              {{ forms[card.id].answer.label }}
              {{ forms[card.id].answer(class="form-control auto-expand flashcard-answer") }}
          </div>

          <!-- Flip button -->
          <div class="mb-3">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm flip-card-btn">
                  Flip question & answer
              </button>
          </div>

          <div class="mb-3">
              Repetitions: {{ card.level }} <br>
              {% if card.last_review %}
                Last: {{ (card.last_review).strftime('%Y-%m-%d %H:%M') }}<br>
              {% else %}
                Last: never<br>
              {% endif %}
              {% if card.next_review %}
                Next: {{ (card.next_review).strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                Next: Never
              {% endif %}
              <br>
              {% if card.reviewed_by_tc == False %}
                  <button name="action" value="mark_reviewed_tc" class="btn btn-success">
                    Review
                  </button>
              {% endif %}
            
              <span class="tc-status">
              {% if card.reviewed_by_tc %}‚úÖ Teacher reviewed{% endif %}
              </span>
          </div>

          <button name="action" value="edit" class="btn btn-primary">Edit</button>
          <button name="action" value="delete" class="btn btn-danger" onclick="return confirm('Delete this flashcard?');">Delete</button>
      </form>
  </div>
{% endfor %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.flip-card-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      const form = btn.closest('.flashcard-form');
      if (!form) return;

      const questionField = form.querySelector('.flashcard-question');
      const answerField   = form.querySelector('.flashcard-answer');

      if (!questionField || !answerField) return;

      const temp = questionField.value;
      questionField.value = answerField.value;
      answerField.value = temp;
    });
  });
});
</script>

{% endblock %}
</div>


  {% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/flashcard-search.js') }}"></script>
  {% endblock %}