


<form action="{{ url_for('calendar.teacher_calendar', user_name=current_user.user_name) }}" method="get">
  <button type="submit" class="btn btn-primary">
    Check Calendar
  </button>
</form>


{% if assigned_students %}
  <div class="section-box">
    <h3 class="mt-4">Assigned Students</h3>
    <ul class="list-group mb-4">

      
  <div class="accordion" id="studentsAccordion">
  {% for student in assigned_students %}
    {% set unrev = unreviewed_counts.get(student.id) %}
    <div class="accordion-item mb-2 border-0">
      <h2 class="accordion-header" id="heading-{{ loop.index }}">
        <button class="accordion-button collapsed w-100 py-3 fw-semibold {% if unrev %}bg-warning-subtle{% endif %}"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ loop.index }}"
                aria-expanded="false"
                aria-controls="collapse-{{ loop.index }}">
          <span>
            {{ student.name }} 
            {% if unrev %}
              <span class="badge bg-danger ms-2">{{ unrev }} unreviewed</span>
            {% endif %}
          </span>
        </button>
      </h2>

      <div id="collapse-{{ loop.index }}"
           class="accordion-collapse collapse"
           aria-labelledby="heading-{{ loop.index }}"
           data-bs-parent="#studentsAccordion">
        <div class="accordion-body">
          <p class="text-muted small mb-3">
            {{ student.email }}<br>
            Role: {{ student.role }} | ID: {{ student.id }}<br>
            Level: {{ student.level }}
          </p>

          <!-- Vertical stack of actions -->
          <div class="d-flex flex-column gap-2">

            <!-- 1) Manage flashcards -->
            <a href="{{ url_for('flashcard.manage_student', student_id=student.id) }}"
               class="btn btn-secondary btn-sm w-100">
              Manage flashcards
            </a>

            <!-- 2) Audiobook (opens modal) -->
            <button type="button"
                    class="btn btn-secondary btn-sm w-100"
                    data-bs-toggle="modal"
                    data-bs-target="#audiobookModal-{{ student.id }}">
              Audiobook
            </button>
 
            <p class="small mb-1">
              Current audiobook:
            </p>
            <small class="d-block mt-1">
              {% if student.audiobook %}
                <a href="{{ url_for('audiobook.audiobooks', user_id=student.id) }}"
                  class="text-muted text-decoration-none">
                  {{ student.audiobook.title }}
                </a>
              {% else %}
                <span class="text-muted">No audiobook assigned</span>
              {% endif %}
            </small>

            <div class="mt-3">
              <form method="post"
                    action="{{ url_for('admin.set_language', student_id=student.id) }}"
                    class="d-flex gap-2 align-items-center">
                {{ update_learning_language_form.hidden_tag() }}

                <select name="learning_language" class="form-select form-select-sm w-auto">
                  <option value="en"
                          {% if student.learning_language == 'en' %}selected{% endif %}>
                    English
                  </option>
                  <option value="pt-BR"
                          {% if student.learning_language == 'pt-BR' %}selected{% endif %}>
                    Brazilian Portuguese
                  </option>
                </select>

                {{ update_learning_language_form.submit(class_="btn btn-secondary btn-sm") }}
              </form>
            </div>

            <!-- 3) Update level -->
            <form action="{{ url_for('admin.update_student_level') }}"
                  method="post"
                  class="d-flex gap-2 align-items-center mt-2">
              {{ change_student_level_form.csrf_token }}
              {{ change_student_level_form.student_id(value=student.id) }}

              {{ change_student_level_form.level(class="form-select form-select-sm w-auto") }}
              {{ change_student_level_form.submit(class="btn btn-secondary btn-sm") }}
            </form>

          </div>
        </div>
      </div>
    </div>

    <!-- Modal for uploading audiobook for this student -->
    <div class="modal fade audiobook-modal"
        id="audiobookModal-{{ student.id }}"
        tabindex="-1"
        aria-labelledby="audiobookModalLabel-{{ student.id }}"
        aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <form method="post"
                action="{{ url_for('audiobook.assign_audiobook', user_id=student.id) }}"
                enctype="multipart/form-data">
            {{ audiobook_form.hidden_tag() }}

            <div class="modal-header py-2">
              <h5 class="modal-title fs-6" id="audiobookModalLabel-{{ student.id }}">
                Upload audiobook for {{ student.user_name or student.name }}
              </h5>
              <button type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>

            <div class="modal-body py-3">
              <div class="mb-2">
                {{ audiobook_form.text_file.label(class_="form-label mb-1 small") }}
                {{ audiobook_form.text_file(class_="form-control form-control-sm") }}
                {% for error in audiobook_form.text_file.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>

              <div class="mb-2">
                {{ audiobook_form.audio_file.label(class_="form-label mb-1 small") }}
                {{ audiobook_form.audio_file(class_="form-control form-control-sm") }}
                {% for error in audiobook_form.audio_file.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>

              <p class="text-muted small mb-0">
                Máx. ~10 MB (texto + áudio). Use .txt para o texto e .mp3 para o áudio.
              </p>
            </div>

            <div class="modal-footer py-2">
              <button type="button"
                      class="btn btn-sm btn-secondary"
                      data-bs-dismiss="modal">
                Cancel
              </button>
              {{ audiobook_form.submit(class_="btn btn-sm btn-primary") }}
            </div>
          </form>
        </div>
      </div>
    </div>

  {% endfor %}
</div>


</div>

    </ul>
  </div>
{% else %}
  <h2>No students assigned yet.</h2>
{% endif %}
<br><br>
<h2 class="mb-4">Personal User Information</h2>


